        // ---------- VARIABLES GLOBALES ----------
        let currentScreen = 'start';
        let selectedQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let score = 0;
        let wrongQuestions = [];
        let currentLanguage = 'en';
        let studentData = { name: '', doc: '' };
        let teacherCredentials = { username: 'Coach', password: '19082008' };
        
        // NUEVA VARIABLE: Almacena el orden fijo de opciones por pregunta
        let questionOptionsOrder = {};

        // ---------- FUNCIONES DE NAVEGACIÓN SIMPLIFICADAS ----------
        function showScreen(screenName) {
            // Ocultar todas las pantallas
            const allScreens = document.querySelectorAll('.card');
            allScreens.forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // Mostrar la pantalla solicitada
            const targetScreen = document.getElementById(screenName);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                currentScreen = screenName;
            }
        }

        function showStartScreen() {
            showScreen('start-screen');
        }

        function showTeacherLogin() {
            showScreen('teacher-login-screen');
        }

        function showTeacherMenu() {
            showScreen('teacher-menu-screen');
        }

        function showResultsScreen() {
            showScreen('results-screen');
        }

        // ---------- FUNCIONES DEL QUIZ ----------
        function startQuiz() {
            const name = document.getElementById('name-input').value.trim();
            const doc = document.getElementById('doc-input').value.trim();
            
            if (!name || !doc) {
                alert('Please enter your full name and student ID.');
                return;
            }
            
            studentData = { name, doc };
            
            // Seleccionar 10 preguntas aleatorias
            selectedQuestions = [...questions].sort(() => 0.5 - Math.random()).slice(0, 10);
            currentQuestionIndex = 0;
            userAnswers = {};
            score = 0;
            wrongQuestions = [];
            currentLanguage = 'en';
            questionOptionsOrder = {}; // Reiniciar el orden de opciones
            
            showScreen('quiz-screen');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex >= selectedQuestions.length) {
                finishQuiz();
                return;
            }
            
            const question = selectedQuestions[currentQuestionIndex];
            const questionNum = currentQuestionIndex + 1;
            
            // Actualizar número de pregunta y progreso
            document.getElementById('question-number').textContent = `Question ${questionNum}/10`;
            document.getElementById('progress-fill').style.width = `${(questionNum / 10) * 100}%`;
            
            // Actualizar texto de la pregunta
            document.getElementById('question-text').textContent = 
                currentLanguage === 'en' ? question.en : question.es;
            
            // Actualizar botón de idioma
            document.getElementById('language-btn').textContent = 
                currentLanguage === 'en' ? '🌐 Español' : '🌐 English';
            
            // Generar opciones - CORREGIDO: Orden fijo
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            let displayOptions = [];
            
            // Si ya tenemos un orden guardado para esta pregunta, usarlo
            if (questionOptionsOrder[currentQuestionIndex]) {
                displayOptions = questionOptionsOrder[currentQuestionIndex];
            } else {
                // Generar nuevo orden y guardarlo
                if (question.number >= 26) {
                    // Para preguntas de órganos (26-50)
                    const correctAnswer = question.answer;
                    const allWrongOptions = [
                        "Cow (Bovine stomach)", "Poultry (Gizzard)", "Pig (Small intestine)", 
                        "Sheep (Skin)", "Goat (Abomasum in kids)", "Poultry (Kidney)",
                        "Pig (Cecum)", "Goat (Eyes)", "Cow (Rumen)", "Poultry (Respiratory system)",
                        "Sheep (Penis)", "Pig (Teeth)", "Cow (Ear gland system)", "Poultry (Ovary/Oviduct)",
                        "Goat (Stomach)", "Sheep (Liver)", "Pig (Large intestine)", "Sheep (Mammary gland)",
                        "Cow (Heart)", "Goat (Spleen)", "Poultry (Crop)", "Goat (Horn)", 
                        "Cow (Salivary glands)", "Pig (Skin)", "Sheep (Skin/wool follicles)"
                    ];
                    const wrongOptions = allWrongOptions.filter(opt => opt !== correctAnswer);
                    const selectedWrongOptions = wrongOptions.sort(() => 0.5 - Math.random()).slice(0, 4);
                    displayOptions = [...selectedWrongOptions, correctAnswer].sort(() => 0.5 - Math.random());
                } else {
                    // Para preguntas simples (1-25)
                    displayOptions = ["Cattle", "Poultry", "Pigs", "Sheep", "Goats"];
                    if (!displayOptions.includes(question.answer)) {
                        displayOptions[Math.floor(Math.random() * 5)] = question.answer;
                    }
                    displayOptions = displayOptions.sort(() => 0.5 - Math.random());
                }
                // Guardar el orden para esta pregunta
                questionOptionsOrder[currentQuestionIndex] = displayOptions;
            }
            
            // Crear botones de opciones
            displayOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectOption(option, button);
                
                if (userAnswers[currentQuestionIndex] === option) {
                    button.classList.add('selected');
                }
                
                optionsContainer.appendChild(button);
            });
            
            // Actualizar botones de navegación
            document.getElementById('prev-btn').classList.toggle('hidden', currentQuestionIndex === 0);
            document.getElementById('next-btn').classList.toggle('hidden', currentQuestionIndex === 9);
            document.getElementById('finish-btn').classList.toggle('hidden', currentQuestionIndex !== 9);
        }

        function selectOption(option, button) {
            // Remover selección anterior
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Seleccionar nueva opción
            button.classList.add('selected');
            userAnswers[currentQuestionIndex] = option;
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
            loadQuestion(); // El orden de opciones se mantiene igual
        }

        function nextQuestion() {
            if (currentQuestionIndex < selectedQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function finishQuiz() {
            // Calcular puntaje
            score = 0;
            wrongQuestions = [];
            
            selectedQuestions.forEach((question, index) => {
                if (userAnswers[index] === question.answer) {
                    score += 2; // 2 puntos por respuesta correcta
                } else {
                    wrongQuestions.push({
                        number: question.number,
                        question_en: question.en,
                        question_es: question.es,
                        user_answer: userAnswers[index] || 'No answer',
                        correct_answer: question.answer
                    });
                }
            });
            
            // Mostrar resultados
            const percentage = (score / 20) * 100;
            const roundedScore = Math.ceil(score);
            
            document.getElementById('final-score').textContent = `${score.toFixed(1)}/20 (${percentage.toFixed(1)}%)`;
            document.getElementById('student-info').textContent = 
                `Student: ${studentData.name} | ID: ${studentData.doc}`;
            
            // Determinar emoji y color según puntaje
            let emoji, text, color;
            if (percentage >= 90) {
                emoji = '🎉'; text = 'Excellent!'; color = '#2ecc71';
            } else if (percentage >= 70) {
                emoji = '👍'; text = 'Good job!'; color = '#f39c12';
            } else {
                emoji = '📚'; text = 'Keep studying!'; color = '#e74c3c';
            }
            
            document.getElementById('result-emoji').textContent = emoji;
            document.getElementById('result-text').textContent = text;
            document.getElementById('final-score').style.color = color;
            
            // Mostrar botón de respuestas incorrectas si hay
            document.getElementById('wrong-answers-btn').classList.toggle('hidden', wrongQuestions.length === 0);
            
            showScreen('results-screen');
            
            // Guardar resultado - CORREGIDO: Almacenamiento persistente
            saveResult(studentData.name, studentData.doc, score, percentage, roundedScore);
        }

        function showWrongAnswers() {
            const container = document.getElementById('wrong-answers-container');
            container.innerHTML = '';
            
            if (wrongQuestions.length === 0) {
                container.innerHTML = '<p>No wrong answers to review.</p>';
            } else {
                wrongQuestions.forEach((wq, index) => {
                    const wrongAnswerDiv = document.createElement('div');
                    wrongAnswerDiv.className = 'wrong-answer-item';
                    wrongAnswerDiv.innerHTML = `
                        <h4>Question ${wq.number}</h4>
                        <p><strong>English:</strong> ${wq.question_en}</p>
                        <p><strong>Español:</strong> ${wq.question_es}</p>
                        <p style="color: #e74c3c;"><strong>Your answer:</strong> ${wq.user_answer}</p>
                        <p style="color: #27ae60;"><strong>Correct answer:</strong> ${wq.correct_answer}</p>
                    `;
                    container.appendChild(wrongAnswerDiv);
                });
            }
            
            showScreen('wrong-answers-screen');
        }

        // ---------- FUNCIONES DE PROFESOR ----------
        function verifyLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === teacherCredentials.username && password === teacherCredentials.password) {
                showTeacherMenu();
            } else {
                alert('Invalid credentials. Please try again.');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('username').focus();
            }
        }

        function changeUsername() {
            const newUsername = prompt('Enter new username:', teacherCredentials.username);
            if (newUsername && newUsername.trim()) {
                teacherCredentials.username = newUsername.trim();
                // Guardar en localStorage
                localStorage.setItem('teacherUsername', teacherCredentials.username);
                alert('Username updated successfully!');
            }
        }

        function changePassword() {
            const newPassword = prompt('Enter new password:');
            if (newPassword && newPassword.trim()) {
                teacherCredentials.password = newPassword.trim();
                // Guardar en localStorage
                localStorage.setItem('teacherPassword', teacherCredentials.password);
                alert('Password updated successfully!');
            }
        }

        function deleteDatabase() {
            if (confirm('Are you sure you want to delete ALL student results?\nThis action cannot be undone.')) {
                localStorage.removeItem('quizResults');
                alert('All results deleted successfully!');
            }
        }

        function viewRanking() {
            const results = getResults();
            const container = document.getElementById('ranking-table-container');
            
            if (results.length === 0) {
                container.innerHTML = '<p>No results found.</p>';
            } else {
                let html = `
                    <table class="ranking-table">
                        <tr>
                            <th>Pos</th>
                            <th>Name</th>
                            <th>ID</th>
                            <th>Score</th>
                            <th>Percentage</th>
                            <th>Rounded</th>
                            <th>Date</th>
                        </tr>
                `;
                
                results.sort((a, b) => b.percentage - a.percentage);
                
                results.forEach((result, index) => {
                    let rowClass = '';
                    if (index === 0) rowClass = 'gold';
                    else if (index === 1) rowClass = 'silver';
                    else if (index === 2) rowClass = 'bronze';
                    
                    const date = new Date(result.timestamp).toLocaleDateString();
                    
                    html += `
                        <tr class="${rowClass}">
                            <td>${index + 1}</td>
                            <td>${result.name}</td>
                            <td>${result.doc}</td>
                            <td>${result.score}</td>
                            <td>${result.percentage}%</td>
                            <td><strong>${result.roundedScore}</strong></td>
                            <td>${date}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                container.innerHTML = html;
            }
            
            showScreen('ranking-screen');
        }

        // ---------- ALMACENAMIENTO PERSISTENTE (localStorage) ----------
        function saveResult(name, doc, score, percentage, roundedScore) {
            const results = getResults();
            results.push({
                name,
                doc,
                score: score.toFixed(1),
                percentage: percentage.toFixed(1),
                roundedScore,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('quizResults', JSON.stringify(results));
        }

        function getResults() {
            return JSON.parse(localStorage.getItem('quizResults') || '[]');
        }

        function loadTeacherCredentials() {
            // Cargar credenciales guardadas
            const savedUsername = localStorage.getItem('teacherUsername');
            const savedPassword = localStorage.getItem('teacherPassword');
            
            if (savedUsername) teacherCredentials.username = savedUsername;
            if (savedPassword) teacherCredentials.password = savedPassword;
        }

        function exportToExcel() {
            const results = getResults();
            if (results.length === 0) {
                alert('No results to export.');
                return;
            }
            
            let csvContent = "Name,ID,Score,Percentage,Rounded Score,Date\n";
            results.forEach(result => {
                const date = new Date(result.timestamp).toLocaleDateString();
                csvContent += `"${result.name}","${result.doc}",${result.score},${result.percentage},${result.roundedScore},${date}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'VetQuiz_Results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('Results exported as CSV file!');
        }

        function exportToCSV() {
            exportToExcel();
        }

        // ---------- INICIALIZACIÓN ----------
        function initializeApp() {
            loadTeacherCredentials();
            showStartScreen();
            
            // Event listeners para Enter key
            document.getElementById('name-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('doc-input').focus();
                }
            });

            document.getElementById('doc-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    startQuiz();
                }
            });

            document.getElementById('username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('password').focus();
                }
            });

            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyLogin();
                }
            });
        }

        // Inicializar la aplicación cuando se carga la página
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
