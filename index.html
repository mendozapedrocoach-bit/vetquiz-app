<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VetQuizApp - U.P.T.N.T. Manuela Saenz</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .text-input, .select-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            font-family: inherit;
        }
        
        .text-input:focus, .select-input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .question {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db;
        }
        
        .question h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            line-height: 1.4;
        }
        
        .option-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option-btn:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
        
        .option-btn.selected {
            border-color: #2ecc71;
            background: #d5f4e6;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border-radius: 10px;
            transition: width 0.3s;
        }
        
        .results {
            text-align: center;
            padding: 20px;
        }
        
        .score {
            font-size: 48px;
            font-weight: bold;
            color: #2ecc71;
            margin: 20px 0;
        }
        
        .emoji {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .language-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .ranking-table th,
        .ranking-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .ranking-table th {
            background: #34495e;
            color: white;
        }
        
        .ranking-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .gold { background: #FFF9C4 !important; }
        .silver { background: #F5F5F5 !important; }
        .bronze { background: #FFE0B2 !important; }
        
        .wrong-answers-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .wrong-answer-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- PANTALLA DE INICIO -->
        <div id="start-screen" class="card">
            <div class="header">
                <h1>Welcome to VetQuizApp ü©∫</h1>
                <p>U.P.T.N.T. Manuela Saenz</p>
            </div>
            
            <div class="input-group">
                <label for="name-input">Full Name:</label>
                <input type="text" id="name-input" class="text-input" placeholder="Enter your full name">
            </div>
            
            <div class="input-group">
                <label for="doc-input">Student ID:</label>
                <input type="text" id="doc-input" class="text-input" placeholder="Enter your student ID">
            </div>
            
            <button class="btn btn-primary" onclick="startQuiz()">Start Quiz</button>
            <button class="btn btn-secondary" onclick="showTeacherLogin()">Teacher Access</button>
            
            <div id="start-alert"></div>
        </div>

        <!-- PANTALLA DE LOGIN PROFESOR -->
        <div id="teacher-login-screen" class="card hidden">
            <div class="header">
                <h1>Teacher Login üßë‚Äçüè´</h1>
            </div>
            
            <div class="input-group">
                <label for="username">Username:</label>
                <input type="text" id="username" class="text-input" placeholder="Enter username">
            </div>
            
            <div class="input-group">
                <label for="password">Password:</label>
                <input type="password" id="password" class="text-input" placeholder="Enter password">
            </div>
            
            <button class="btn btn-primary" id="login-btn" onclick="verifyLogin()">Login</button>
            <button class="btn btn-secondary" onclick="showStartScreen()">Back to Main Menu</button>
            
            <div id="login-alert"></div>
        </div>

        <!-- PANTALLA DE QUIZ -->
        <div id="quiz-screen" class="card hidden">
            <div class="header">
                <h3 id="question-number">Question 1/10</h3>
                <button class="language-btn" onclick="toggleLanguage()" id="language-btn">üåê Espa√±ol</button>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 10%"></div>
            </div>
            
            <div class="question">
                <h3 id="question-text">Loading question...</h3>
            </div>
            
            <div id="options-container">
                <!-- Las opciones se cargan aqu√≠ din√°micamente -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="prevQuestion()" id="prev-btn" style="flex: 1;">‚Üê Back</button>
                <button class="btn btn-primary" onclick="nextQuestion()" id="next-btn" style="flex: 1;">Next ‚Üí</button>
                <button class="btn btn-success hidden" onclick="finishQuiz()" id="finish-btn" style="flex: 1;">Finish Quiz</button>
            </div>
        </div>
                <!-- PANTALLA DE RESULTADOS -->
        <div id="results-screen" class="card hidden">
            <div class="results">
                <div class="emoji" id="result-emoji">üéØ</div>
                <h2 id="result-text">Quiz Completed!</h2>
                <div class="score" id="final-score">0/20</div>
                <p id="student-info"></p>
                
                <div id="save-alert"></div>
                
                <button class="btn btn-primary" onclick="showStartScreen()">Return to Main Menu</button>
                <button class="btn btn-success" onclick="startQuiz()">Restart Quiz</button>
                <button class="btn btn-danger hidden" onclick="showWrongAnswers()" id="wrong-answers-btn">‚ùå View Wrong Answers</button>
            </div>
        </div>

        <!-- MEN√ö PROFESOR -->
        <div id="teacher-menu-screen" class="card hidden">
            <div class="header">
                <h1>Teacher Menu üßë‚Äçüè´</h1>
                <p>Administrative Panel</p>
            </div>
            
            <button class="btn btn-primary" onclick="viewRanking()">üìä View Results & Ranking</button>
            <button class="btn btn-warning" onclick="changeUsername()">üìù Change Username</button>
            <button class="btn btn-warning" onclick="changePassword()">üîë Change Password</button>
            <button class="btn btn-danger" onclick="deleteDatabase()">üóëÔ∏è Delete All Results</button>
            <button class="btn btn-secondary" onclick="showStartScreen()">‚¨ÖÔ∏è Back to Main Menu</button>
            
            <div id="teacher-alert"></div>
        </div>

        <!-- RANKING Y RESULTADOS -->
        <div id="ranking-screen" class="card hidden">
            <div class="header">
                <h1>Student Ranking üìä</h1>
                <p>All quiz results</p>
            </div>
            
            <div id="ranking-table-container">
                <!-- La tabla de ranking se carga aqu√≠ -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="exportToExcel()" style="flex: 1;">üíæ Export to Excel</button>
                <button class="btn btn-primary" onclick="exportToCSV()" style="flex: 1;">üìÑ Export to CSV</button>
                <button class="btn btn-secondary" onclick="showTeacherMenu()" style="flex: 1;">‚¨ÖÔ∏è Back</button>
            </div>
            
            <div id="ranking-alert"></div>
        </div>

        <!-- PREGUNTAS INCORRECTAS -->
        <div id="wrong-answers-screen" class="card hidden">
            <div class="header">
                <h1>Wrong Answers Review üìù</h1>
                <p>Learn from your mistakes</p>
            </div>
            
            <div id="wrong-answers-container">
                <!-- Las preguntas incorrectas se cargan aqu√≠ -->
            </div>
            
            <button class="btn btn-secondary" onclick="showResultsScreen()">‚¨ÖÔ∏è Back to Results</button>
        </div>
    </div>

    <script>
        // ========== CONFIGURACI√ìN GOOGLE APPS SCRIPT ==========
        // REEMPLAZA ESTA URL CON LA DE TU GOOGLE APPS SCRIPT
        const GOOGLE_SCRIPT_URL = 'AKfycbzNGmQGkzpzSpyZneet2P0GDpCLUhJGuT4cqT6YOreTpCHYfRufCH1QGHztDpwb_CcYlg';

        // ========== PREGUNTAS DEL QUIZ ==========
        const questions = [
            // Preguntas 1-25 (simples)
            {"en": "Produce hides widely used in the leather industry.", 
             "es": "Produce cueros ampliamente utilizados en la industria del cuero.",
             "answer": "Cattle", "number": 1},
            {"en": "Have no teeth; they grind food in the gizzard.", 
             "es": "No tienen dientes; trituran la comida en la molleja.",
             "answer": "Poultry", "number": 2},
            // ... (mantener todas las 50 preguntas del c√≥digo anterior)
            {"en": "This organ produces wool fibers that have commercial value.", 
             "es": "Este √≥rgano produce fibras de lana que tienen valor comercial.",
             "answer": "Sheep (Skin/wool follicles)", "number": 50}
        ];

        // ========== VARIABLES GLOBALES ==========
        let currentScreen = 'start';
        let selectedQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let score = 0;
        let wrongQuestions = [];
        let currentLanguage = 'en';
        let studentData = { name: '', doc: '' };
        let questionOptionsOrder = {};
        
        // Credenciales de profesor (se guardan en localStorage como respaldo)
        let teacherCredentials = { 
            username: localStorage.getItem('teacherUsername') || 'Coach', 
            password: localStorage.getItem('teacherPassword') || '19082008' 
        };

        // ========== FUNCIONES DE NAVEGACI√ìN ==========
        function showScreen(screenName) {
            document.querySelectorAll('.card').forEach(screen => {
                screen.classList.add('hidden');
            });
            const targetScreen = document.getElementById(screenName);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                currentScreen = screenName;
            }
        }

        function showStartScreen() { showScreen('start-screen'); }
        function showTeacherLogin() { showScreen('teacher-login-screen'); }
        function showTeacherMenu() { showScreen('teacher-menu-screen'); }
        function showResultsScreen() { showScreen('results-screen'); }

        // ========== FUNCIONES DEL QUIZ ==========
        function startQuiz() {
            const name = document.getElementById('name-input').value.trim();
            const doc = document.getElementById('doc-input').value.trim();
            
            if (!name || !doc) {
                showAlert('start-alert', 'Please enter your full name and student ID.', 'error');
                return;
            }
            
            studentData = { name, doc };
            selectedQuestions = [...questions].sort(() => 0.5 - Math.random()).slice(0, 10);
            currentQuestionIndex = 0;
            userAnswers = {};
            score = 0;
            wrongQuestions = [];
            currentLanguage = 'en';
            questionOptionsOrder = {};
            
            showScreen('quiz-screen');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex >= selectedQuestions.length) {
                finishQuiz();
                return;
            }
            
            const question = selectedQuestions[currentQuestionIndex];
            const questionNum = currentQuestionIndex + 1;
            
            document.getElementById('question-number').textContent = `Question ${questionNum}/10`;
            document.getElementById('progress-fill').style.width = `${(questionNum / 10) * 100}%`;
            document.getElementById('question-text').textContent = 
                currentLanguage === 'en' ? question.en : question.es;
            document.getElementById('language-btn').textContent = 
                currentLanguage === 'en' ? 'üåê Espa√±ol' : 'üåê English';
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            let displayOptions = [];
            
            if (questionOptionsOrder[currentQuestionIndex]) {
                displayOptions = questionOptionsOrder[currentQuestionIndex];
            } else {
                if (question.number >= 26) {
                    const correctAnswer = question.answer;
                    const allWrongOptions = [
                        "Cow (Bovine stomach)", "Poultry (Gizzard)", "Pig (Small intestine)", 
                        "Sheep (Skin)", "Goat (Abomasum in kids)", "Poultry (Kidney)",
                        "Pig (Cecum)", "Goat (Eyes)", "Cow (Rumen)", "Poultry (Respiratory system)",
                        "Sheep (Penis)", "Pig (Teeth)", "Cow (Ear gland system)", "Poultry (Ovary/Oviduct)",
                        "Goat (Stomach)", "Sheep (Liver)", "Pig (Large intestine)", "Sheep (Mammary gland)",
                        "Cow (Heart)", "Goat (Spleen)", "Poultry (Crop)", "Goat (Horn)", 
                        "Cow (Salivary glands)", "Pig (Skin)", "Sheep (Skin/wool follicles)"
                    ];
                    const wrongOptions = allWrongOptions.filter(opt => opt !== correctAnswer);
                    const selectedWrongOptions = wrongOptions.sort(() => 0.5 - Math.random()).slice(0, 4);
                    displayOptions = [...selectedWrongOptions, correctAnswer].sort(() => 0.5 - Math.random());
                } else {
                    displayOptions = ["Cattle", "Poultry", "Pigs", "Sheep", "Goats"];
                    if (!displayOptions.includes(question.answer)) {
                        displayOptions[Math.floor(Math.random() * 5)] = question.answer;
                    }
                    displayOptions = displayOptions.sort(() => 0.5 - Math.random());
                }
                questionOptionsOrder[currentQuestionIndex] = displayOptions;
            }
            
            displayOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectOption(option, button);
                
                if (userAnswers[currentQuestionIndex] === option) {
                    button.classList.add('selected');
                }
                
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('prev-btn').classList.toggle('hidden', currentQuestionIndex === 0);
            document.getElementById('next-btn').classList.toggle('hidden', currentQuestionIndex === 9);
            document.getElementById('finish-btn').classList.toggle('hidden', currentQuestionIndex !== 9);
        }

        function selectOption(option, button) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            userAnswers[currentQuestionIndex] = option;
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
            loadQuestion();
        }

        function nextQuestion() {
            if (currentQuestionIndex < selectedQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }
                    // ========== FUNCIONES DE GOOGLE SHEETS (BASE DE DATOS) ==========
        async function saveToGoogleSheets(data) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveResult',
                        data: data
                    })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                // Fallback a localStorage si hay error
                saveToLocalStorage(data);
                return { success: false, error: error.message };
            }
        }

        async function getResultsFromGoogleSheets() {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getResults&timestamp=${Date.now()}`);
                const results = await response.json();
                return results;
            } catch (error) {
                console.error('Error getting results from Google Sheets:', error);
                // Fallback a localStorage
                return getResultsFromLocalStorage();
            }
        }

        async function deleteAllResultsFromGoogleSheets() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'deleteAllResults'
                    })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error deleting from Google Sheets:', error);
                return { success: false, error: error.message };
            }
        }

        // ========== FUNCIONES LOCALSTORAGE (FALLBACK) ==========
        function saveToLocalStorage(data) {
            const results = JSON.parse(localStorage.getItem('quizResults') || '[]');
            results.push(data);
            localStorage.setItem('quizResults', JSON.stringify(results));
        }

        function getResultsFromLocalStorage() {
            return JSON.parse(localStorage.getItem('quizResults') || '[]');
        }

        function deleteAllFromLocalStorage() {
            localStorage.removeItem('quizResults');
        }

        // ========== FUNCIONES PRINCIPALES MEJORADAS ==========
        async function finishQuiz() {
            // Calcular puntaje
            score = 0;
            wrongQuestions = [];
            
            selectedQuestions.forEach((question, index) => {
                if (userAnswers[index] === question.answer) {
                    score += 2;
                } else {
                    wrongQuestions.push({
                        number: question.number,
                        question_en: question.en,
                        question_es: question.es,
                        user_answer: userAnswers[index] || 'No answer',
                        correct_answer: question.answer
                    });
                }
            });
            
            const percentage = (score / 20) * 100;
            const roundedScore = Math.ceil(score);
            
            document.getElementById('final-score').textContent = `${score.toFixed(1)}/20 (${percentage.toFixed(1)}%)`;
            document.getElementById('student-info').textContent = 
                `Student: ${studentData.name} | ID: ${studentData.doc}`;
            
            let emoji, text, color;
            if (percentage >= 90) {
                emoji = 'üéâ'; text = 'Excellent!'; color = '#2ecc71';
            } else if (percentage >= 70) {
                emoji = 'üëç'; text = 'Good job!'; color = '#f39c12';
            } else {
                emoji = 'üìö'; text = 'Keep studying!'; color = '#e74c3c';
            }
            
            document.getElementById('result-emoji').textContent = emoji;
            document.getElementById('result-text').textContent = text;
            document.getElementById('final-score').style.color = color;
            
            document.getElementById('wrong-answers-btn').classList.toggle('hidden', wrongQuestions.length === 0);
            showScreen('results-screen');
            
            // Guardar resultado EN LA NUBE
            const resultData = {
                name: studentData.name,
                doc: studentData.doc,
                score: score.toFixed(1),
                percentage: percentage.toFixed(1),
                roundedScore: roundedScore,
                timestamp: new Date().toISOString(),
                wrongAnswers: wrongQuestions.length
            };
            
            showAlert('save-alert', 'Saving your results...', 'loading');
            
            const saveResult = await saveToGoogleSheets(resultData);
            
            if (saveResult.success) {
                showAlert('save-alert', 'Results saved successfully in the cloud! ‚úÖ', 'success');
            } else {
                showAlert('save-alert', 'Results saved locally (cloud error).', 'error');
            }
        }

        async function viewRanking() {
            showAlert('ranking-alert', 'Loading results from cloud...', 'loading');
            
            const results = await getResultsFromGoogleSheets();
            const container = document.getElementById('ranking-table-container');
            
            if (results.length === 0) {
                container.innerHTML = '<p>No results found.</p>';
                showAlert('ranking-alert', 'No results available.', 'error');
            } else {
                let html = `
                    <table class="ranking-table">
                        <tr>
                            <th>Pos</th>
                            <th>Name</th>
                            <th>ID</th>
                            <th>Score</th>
                            <th>Percentage</th>
                            <th>Rounded</th>
                            <th>Wrong Answers</th>
                            <th>Date</th>
                        </tr>
                `;
                
                results.sort((a, b) => b.percentage - a.percentage);
                
                results.forEach((result, index) => {
                    let rowClass = '';
                    if (index === 0) rowClass = 'gold';
                    else if (index === 1) rowClass = 'silver';
                    else if (index === 2) rowClass = 'bronze';
                    
                    const date = new Date(result.timestamp).toLocaleDateString();
                    
                    html += `
                        <tr class="${rowClass}">
                            <td>${index + 1}</td>
                            <td>${result.name}</td>
                            <td>${result.doc}</td>
                            <td>${result.score}</td>
                            <td>${result.percentage}%</td>
                            <td><strong>${result.roundedScore}</strong></td>
                            <td>${result.wrongAnswers || 'N/A'}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                container.innerHTML = html;
                showAlert('ranking-alert', `Loaded ${results.length} results from cloud ‚úÖ`, 'success');
            }
            
            showScreen('ranking-screen');
        }

        function showWrongAnswers() {
            const container = document.getElementById('wrong-answers-container');
            container.innerHTML = '';
            
            if (wrongQuestions.length === 0) {
                container.innerHTML = '<p>No wrong answers to review.</p>';
            } else {
                wrongQuestions.forEach((wq, index) => {
                    const wrongAnswerDiv = document.createElement('div');
                    wrongAnswerDiv.className = 'wrong-answer-item';
                    wrongAnswerDiv.innerHTML = `
                        <h4>Question ${wq.number}</h4>
                        <p><strong>English:</strong> ${wq.question_en}</p>
                        <p><strong>Espa√±ol:</strong> ${wq.question_es}</p>
                        <p style="color: #e74c3c;"><strong>Your answer:</strong> ${wq.user_answer}</p>
                        <p style="color: #27ae60;"><strong>Correct answer:</strong> ${wq.correct_answer}</p>
                    `;
                    container.appendChild(wrongAnswerDiv);
                });
            }
            
            showScreen('wrong-answers-screen');
        }

        // ========== FUNCIONES DE PROFESOR ==========
        async function verifyLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');
            
            loginBtn.innerHTML = '<div class="loading"></div> Checking...';
            loginBtn.disabled = true;
            
            if (username === teacherCredentials.username && password === teacherCredentials.password) {
                showAlert('login-alert', 'Login successful!', 'success');
                setTimeout(() => showTeacherMenu(), 1000);
            } else {
                showAlert('login-alert', 'Invalid credentials. Please try again.', 'error');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('username').focus();
            }
            
            loginBtn.innerHTML = 'Login';
            loginBtn.disabled = false;
        }

        function changeUsername() {
            const newUsername = prompt('Enter new username:', teacherCredentials.username);
            if (newUsername && newUsername.trim()) {
                teacherCredentials.username = newUsername.trim();
                localStorage.setItem('teacherUsername', teacherCredentials.username);
                showAlert('teacher-alert', 'Username updated successfully!', 'success');
            }
        }

        function changePassword() {
            const newPassword = prompt('Enter new password:');
            if (newPassword && newPassword.trim()) {
                teacherCredentials.password = newPassword.trim();
                localStorage.setItem('teacherPassword', teacherCredentials.password);
                showAlert('teacher-alert', 'Password updated successfully!', 'success');
            }
        }

        async function deleteDatabase() {
            if (confirm('Are you sure you want to delete ALL student results from the cloud?\nThis action cannot be undone.')) {
                showAlert('teacher-alert', 'Deleting all results...', 'loading');
                
                const deleteResult = await deleteAllResultsFromGoogleSheets();
                
                if (deleteResult.success) {
                    deleteAllFromLocalStorage();
                    showAlert('teacher-alert', 'All results deleted successfully from cloud!', 'success');
                } else {
                    showAlert('teacher-alert', 'Error deleting from cloud. Try again.', 'error');
                }
            }
        }

        // ========== FUNCIONES UTILITARIAS ==========
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-error' : '';
            
            if (type === 'loading') {
                container.innerHTML = `<div class="alert">${message} <div class="loading" style="display: inline-block; margin-left: 10px;"></div></div>`;
            } else {
                container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            }
            
            if (type !== 'loading') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        function exportToExcel() {
            // Esta funci√≥n puede usar los datos ya cargados en viewRanking()
            alert('Use the "Export to CSV" button for best compatibility.');
        }

        function exportToCSV() {
            const results = getResultsFromLocalStorage();
            if (results.length === 0) {
                alert('No results to export.');
                return;
            }
            
            let csvContent = "Name,ID,Score,Percentage,Rounded Score,Wrong Answers,Date\n";
            results.forEach(result => {
                const date = new Date(result.timestamp).toLocaleDateString();
                csvContent += `"${result.name}","${result.doc}",${result.score},${result.percentage},${result.roundedScore},${result.wrongAnswers || 'N/A'},${date}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'VetQuiz_Results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('ranking-alert', 'CSV file downloaded successfully!', 'success');
        }

        // ========== INICIALIZACI√ìN ==========
        function initializeApp() {
            showStartScreen();
            
            // Event listeners para Enter key
            document.getElementById('name-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') startQuiz();
            });

            document.getElementById('doc-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') startQuiz();
            });

            document.getElementById('username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') document.getElementById('password').focus();
            });

            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') verifyLogin();
            });
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
